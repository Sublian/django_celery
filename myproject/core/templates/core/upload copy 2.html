{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <!-- üì¶ Tarjeta principal -->
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-success text-white text-center rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-cloud-upload"></i> Subir nuevo archivo</h4>
                </div>

                <div class="card-body p-4">
                    <form id="uploadForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_name" class="form-label fw-semibold">Nombre descriptivo</label>
                            <input type="text" name="name" class="form-control shadow-sm" id="id_name"
                                   placeholder="Ejemplo: Correlaciones octubre 2025" required>
                            <div class="invalid-feedback">Por favor, ingresa un nombre descriptivo.</div>
                        </div>

                        <div class="mb-3">
                            <label for="id_file" class="form-label fw-semibold">Archivo (.csv o .xlsx)</label>
                            <input type="file" name="file" class="form-control shadow-sm" id="id_file" accept=".csv,.xlsx" required>
                            <div class="invalid-feedback">Selecciona un archivo v√°lido (.csv o .xlsx).</div>
                        </div>

                        <div id="uploadStatus" class="text-muted small mb-3"></div>

                        <button type="submit" class="btn btn-success w-100 shadow-sm" id="upload-btn">
                            <i class="bi bi-cloud-arrow-up"></i> Subir archivo
                        </button>
                    </form>
                </div>
            </div>

            <!-- üóÇÔ∏è √öltimos archivos -->
            {% if recent_files %}
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-light fw-bold">
                    <i class="bi bi-clock-history"></i> √öltimos archivos subidos
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Archivo</th>
                                <th>Estado</th>
                                <th>Procesado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in recent_files %}
                            <tr>
                                <td class="fw-semibold">{{ f.name }}</td>
                                <td class="text-muted">{{ f.file.name|cut:"uploads/" }}</td>
                                <td>
                                    {% if f.status == 'done' %}
                                        <span class="badge bg-success">Completado</span>
                                    {% elif f.status == 'error' %}
                                        <span class="badge bg-danger">Error</span>
                                    {% elif f.status == 'processing' %}
                                        <span class="badge bg-warning text-dark">Procesando</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td>{% if f.processed %}‚úÖ{% else %}‚è≥{% endif %}</td>
                                <td class="text-nowrap text-muted small">{{ f.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center text-muted">No hay archivos recientes</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById("uploadForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    const form = this;
    const formData = new FormData(form);
    const statusText = document.getElementById("uploadStatus");
    const button = document.getElementById("upload-btn");

    // Bloquear bot√≥n y mostrar estado
    button.disabled = true;
    statusText.textContent = "‚è≥ Subiendo archivo...";

    try {
        const response = await fetch("{% url 'upload_file' %}", {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        const result = await response.json();
        console.log(result);

        if (response.ok) {
            let title = "";
            let message = "";
            let icon = "";

            if (result.status === "queued" && result.celery_ok && result.redis_ok) {
                title = "‚úÖ ¬°Archivo encolado!";
                message = "El archivo fue agregado correctamente a la cola de tareas.";
                icon = "success";
            } 
            else if (result.status === "pending") {
                title = "‚ö†Ô∏è Tarea pendiente";
                message = "Celery o Redis no est√°n disponibles. La tarea ser√° procesada autom√°ticamente m√°s tarde.";
                icon = "warning";
            } 
            else {
                title = "‚ÑπÔ∏è Archivo registrado";
                message = "El archivo se subi√≥ correctamente.";
                icon = "info";
            }

            await Swal.fire({
                title: title,
                text: message,
                icon: icon,
                timer: 5000,
                timerProgressBar: true,
                showConfirmButton: false
            });

            window.location.href = "{% url 'dashboard' %}";
        } 
        else {
            const errMsg = result.error || "Error desconocido al procesar el archivo.";
            Swal.fire({
                title: "‚ùå Error",
                text: errMsg,
                icon: "error",
                confirmButtonText: "Entendido"
            });
        }

    } catch (error) {
        console.error("Error en la subida:", error);
        Swal.fire({
            title: "‚ùå Error de conexi√≥n",
            text: "No se pudo contactar con el servidor. Verifica tu conexi√≥n o intenta nuevamente.",
            icon: "error",
            confirmButtonText: "Aceptar"
        });
    } finally {
        // Restaurar bot√≥n y limpiar estado
        button.disabled = false;
        statusText.textContent = "";
        form.reset();
    }
});
</script>
{% endblock %}
