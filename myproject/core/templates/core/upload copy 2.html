{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <!-- üì¶ Tarjeta de carga -->
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-success text-white text-center rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-cloud-upload"></i> Subir nuevo archivo</h4>
                </div>
                <div class="card-body">
                    
                    <!-- üì® Mensajes del sistema -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_name" class="form-label">Nombre descriptivo</label>
                            <input type="text" name="name" class="form-control shadow-sm" id="id_name"
                                   placeholder="Ejemplo: Correlaciones octubre 2025" required>
                            <div class="invalid-feedback">Por favor, ingresa un nombre descriptivo.</div>
                        </div>

                        <div class="mb-3">
                            <label for="id_file" class="form-label">Archivo (.csv o .xlsx)</label>
                            <input type="file" name="file" class="form-control shadow-sm" id="id_file" accept=".csv, .xlsx" required>
                            <div class="invalid-feedback">Selecciona un archivo v√°lido (.csv o .xlsx).</div>
                        </div>

                        <button type="submit" class="btn btn-success w-100 shadow-sm">
                            <i class="bi bi-cloud-arrow-up"></i> Subir archivo
                        </button>
                    </form>
                </div>
            </div>

            <!-- üóÇÔ∏è Archivos recientes -->
            {% if recent_files %}
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light fw-bold">
                    <i class="bi bi-clock-history"></i> √öltimos archivos subidos
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Archivo</th>
                                <th>Estado</th>
                                <th>Procesado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in recent_files %}
                            <tr>
                                <td>{{ f.name }}</td>
                                <td>{{ f.file.name|cut:"uploads/" }}</td>
                                <td>
                                    {% if f.status == 'done' %}
                                        <span class="badge bg-success">Completado</span>
                                    {% elif f.status == 'error' %}
                                        <span class="badge bg-danger">Error</span>
                                    {% elif f.status == 'processing' %}
                                        <span class="badge bg-warning text-dark">Procesando</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Pendiente</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if f.processed %}
                                        ‚úÖ
                                    {% else %}
                                        ‚è≥
                                    {% endif %}
                                </td>
                                <td class="text-nowrap">{{ f.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" class="text-center text-muted">No hay archivos recientes</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ‚öôÔ∏è Validaci√≥n Bootstrap -->
<script>
(() => {
  'use strict'
  const forms = document.querySelectorAll('.needs-validation')
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})()
</script>
{% endblock %}
