{# myproject/billing/templates/billing/factura_electronica.html #}
{% extends "billing/base_pdf.html" %} %} %} %}


{% block title %}Factura Electrónica {{ serie_numero }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos específicos para facturas */
    .invoice-title {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 0.5cm;
        font-size: 16pt;
    }
    
    .invoice-number {
        text-align: center;
        font-size: 14pt;
        font-weight: bold;
        color: #c0392b;
        margin-bottom: 0.5cm;
    }
    
    .client-info-section {
        background-color: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 0.5cm;
        margin-bottom: 0.5cm;
    }
    
    .payment-conditions {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 0.3cm;
        margin: 0.5cm 0;
    }
    
    .items-table th {
        background-color: #3498db;
        color: white;
        text-align: center;
    }
    
    .items-table .text-left {
        text-align: left;
    }
    
    .items-table .text-right {
        text-align: right;
    }
    
    .items-table .text-center {
        text-align: center;
    }
    
    .observation-box {
        background-color: #f1f8e9;
        border: 1px solid #c5e1a5;
        border-radius: 4px;
        padding: 0.5cm;
        margin-top: 0.5cm;
        font-size: 10pt;
    }
    
    .qr-section {
        text-align: center;
        margin-top: 1cm;
        page-break-inside: avoid;
    }
    
    .qr-placeholder {
        display: inline-block;
        width: 120px;
        height: 120px;
        background-color: #ecf0f1;
        border: 2px dashed #bdc3c7;
        line-height: 120px;
        color: #7f8c8d;
        margin: 0.5cm auto;
        font-size: 9pt;
    }
    
    .legal-text {
        font-size: 8pt;
        color: #666;
        text-align: justify;
        margin-top: 0.5cm;
        border-top: 1px solid #eee;
        padding-top: 0.3cm;
    }
</style>
{% endblock %}

{% block document_header %}
<h2 style="margin: 0; color: #2980b9; font-size: 14pt;">FACTURA ELECTRÓNICA</h2>
<p style="margin: 0.2cm 0; font-size: 10pt; font-weight: bold;">
    {{ serie_numero }}
</p>
<p style="margin: 0; font-size: 9pt;">
    Fecha Emisión: {{ fecha_emision }}<br>
    {% if fecha_vencimiento %}
    Fecha Vencimiento: {{ fecha_vencimiento }}
    {% endif %}
</p>
{% endblock %}

{% block content %}
<!-- Título principal -->
<div class="invoice-title">
    <h1 style="margin: 0;">FACTURA ELECTRÓNICA</h1>
    <div class="invoice-number">{{ serie_numero }}</div>
</div>

<!-- Información del cliente -->
<div class="client-info-section">
    <h3 style="margin: 0 0 0.3cm 0; color: #2c3e50; font-size: 12pt;">
        <span style="border-bottom: 2px solid #3498db; padding-bottom: 0.1cm;">INFORMACIÓN DEL CLIENTE</span>
    </h3>
    
    <table style="width: 100%; border: none;">
        <tr>
            <td style="border: none; padding: 0.1cm; width: 100px;"><strong>Razón Social:</strong></td>
            <td style="border: none; padding: 0.1cm;">{{ cliente|upper }}</td>
        </tr>
        <tr>
            <td style="border: none; padding: 0.1cm;"><strong>RUC:</strong></td>
            <td style="border: none; padding: 0.1cm;">{{ ruc_cliente }}</td>
        </tr>
        <tr>
            <td style="border: none; padding: 0.1cm;"><strong>Dirección:</strong></td>
            <td style="border: none; padding: 0.1cm;">{{ direccion_cliente }}</td>
        </tr>
        {% if condiciones_pago %}
        <tr>
            <td style="border: none; padding: 0.1cm;"><strong>Condición Pago:</strong></td>
            <td style="border: none; padding: 0.1cm;">{{ condiciones_pago }}</td>
        </tr>
        {% endif %}
    </table>
</div>

<!-- Condiciones de pago -->
{% if condiciones_pago and condiciones_pago != 'CONTADO' %}
<div class="payment-conditions">
    <strong>Condiciones de Crédito:</strong>
    <table style="width: 100%; border: none; margin-top: 0.2cm;">
        {% for cuota in venta_al_credito %}
        <tr>
            <td style="border: none; padding: 0.1cm; width: 50px;">Cuota {{ cuota.cuota }}:</td>
            <td style="border: none; padding: 0.1cm;">{{ cuota.fecha_de_pago }}</td>
            <td style="border: none; padding: 0.1cm; text-align: right;">S/ {{ cuota.importe|floatformat:2 }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

<!-- Tabla de items -->
<div class="mb-2">
    <h4 style="margin: 0.5cm 0; color: #2c3e50; font-size: 11pt;">DETALLE DE PRODUCTOS/SERVICIOS</h4>
    
    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 8%;">Cant.</th>
                <th style="width: 10%;">Unidad</th>
                <th style="width: 12%;">Código</th>
                <th style="width: 35%;" class="text-left">Descripción</th>
                <th style="width: 10%;" class="text-right">V. Unitario</th>
                <th style="width: 10%;" class="text-right">P. Unitario</th>
                <th style="width: 15%;" class="text-right">Valor Venta</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td class="text-center">{{ item.cantidad|floatformat:2 }}</td>
                <td class="text-center">{{ item.unidad_de_medida }}</td>
                <td class="text-center">{{ item.codigo }}</td>
                <td class="text-left">
                    {{ item.descripcion|linebreaksbr }}
                    {% if item.codigo_producto_sunat %}
                    <br><small style="color: #666;">Cód. SUNAT: {{ item.codigo_producto_sunat }}</small>
                    {% endif %}
                </td>
                <td class="text-right">S/ {{ item.valor_unitario|floatformat:2 }}</td>
                <td class="text-right">S/ {{ item.precio_unitario|floatformat:2 }}</td>
                <td class="text-right">S/ {{ item.subtotal|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Totales -->
<div style="clear: both;"></div>
<div class="totals-container">
    <div class="total-row">
        <span>Op. Gravadas:</span>
        <span>S/ {{ totales.gravada }}</span>
    </div>
    <div class="total-row">
        <span>Op. Inafectas:</span>
        <span>S/ {{ total_inafecta|default:"0.00" }}</span>
    </div>
    <div class="total-row">
        <span>Op. Exoneradas:</span>
        <span>S/ {{ total_exonerada|default:"0.00" }}</span>
    </div>
    <div class="total-row">
        <span>Op. Gratuitas:</span>
        <span>S/ {{ total_gratuita|default:"0.00" }}</span>
    </div>
    <div class="total-row" style="border-bottom: 2px solid #ddd;">
        <span>Descuentos:</span>
        <span>S/ {{ total_descuento|default:"0.00" }}</span>
    </div>
    <div class="total-row">
        <span><strong>IGV (18%):</strong></span>
        <span><strong>S/ {{ totales.igv }}</strong></span>
    </div>
    <div class="total-row total-final">
        <span><strong>IMPORTE TOTAL:</strong></span>
        <span><strong>S/ {{ totales.total }}</strong></span>
    </div>
    
    <div style="font-size: 9pt; color: #666; text-align: right; margin-top: 0.3cm;">
        {% if moneda == 'DÓLARES' %}
        Tipo de cambio: {{ tipo_de_cambio|default:"---" }}
        {% endif %}
    </div>
</div>

<div style="clear: both;"></div>

<!-- Observaciones -->
{% if observaciones %}
<div class="observation-box">
    <strong>Observaciones:</strong><br>
    {{ observaciones|linebreaksbr }}
</div>
{% endif %}

<!-- Sección QR (si existe) -->
{% if qr_data or qr_url %}
<div class="qr-section">
    <h4 style="margin: 0.5cm 0; color: #2c3e50; font-size: 11pt;">REPRESENTACIÓN IMPRESA DEL COMPROBANTE ELECTRÓNICO</h4>
    
    <div class="qr-placeholder">
        {% if qr_url %}
        <!-- En producción, usaría: <img src="{{ qr_url }}" width="120" height="120"> -->
        CÓDIGO QR<br>(Generado por Nubefact)
        {% else %}
        CÓDIGO QR<br>(Datos: {{ qr_data|truncatechars:30 }})
        {% endif %}
    </div>
    
    <p style="font-size: 9pt; color: #666;">
        Código Hash: {{ codigo_unico|default:"Generado por SUNAT" }}<br>
        Fecha de emisión: {{ fecha_emision }}
    </p>
</div>
{% endif %}

<!-- Texto legal -->
<div class="legal-text">
    <p>
        <strong>LEYENDA:</strong> Esta factura electrónica ha sido generada y autorizada conforme a la Ley N° 28035, Ley de Firmas y Certificados Digitales, y a la Resolución de Superintendencia N° 007-2006/SUNAT. Representación impresa del comprobante de pago electrónico. Para consultar la validez del comprobante, ingresar a https://www.sunat.gob.pe/ o escanear el código QR.
    </p>
</div>
{% endblock %}

{% block footer %}
<div class="footer">
    <p>
        <strong>Documento Electrónico generado por sistema.</strong><br>
        Representación impresa del Comprobante de Pago Electrónico - {{ serie_numero }}
    </p>
    <p style="font-size: 8pt;">
        Fecha de generación: {% now "d/m/Y H:i" %} | 
        Usuario: {{ user|default:"Sistema" }} |
        Página <pdf:pagenumber> de <pdf:pagecount>
    </p>
</div>
{% endblock %}